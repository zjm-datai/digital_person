# ==================================================================
# WARNING: This file is auto-generated by generate_docker_compose
# Do not modify this file directly. Instead, update the .env.example
# or docker-compose-template.yaml and regenerate this file.
# ==================================================================

x-shared-env: &shared-api-worker-env
  APP_PORT: ${APP_PORT:-5001}
  SECRET_KEY: ${SECRET_KEY:-jRCbkieMC3BQUksY8BfSWCk9CgMHkJy2LiHVqB9m4icxkQonXSWJjbeM}
  LOGIN_DISABLED: ${LOGIN_DISABLED:-False}
  ADMIN_API_KEY_ENABLE: ${ADMIN_API_KEY_ENABLE:-True}
  ADMIN_API_KEY: ${ADMIN_API_KEY:-zhujunmiao}
  CONSOLE_API_URL: ${CONSOLE_API_URL:-http://localhost:5001}
  CONSOLE_WEB_URL: ${CONSOLE_WEB_URL:-http://localhost:3000}
  MINIO_ENDPOINT: ${MINIO_ENDPOINT:-211.90.240.240:30002}
  MINIO_ACCESS_KEY: ${MINIO_ACCESS_KEY:-minioadmin}
  MINIO_SECRET_KEY: ${MINIO_SECRET_KEY:-minioadmin}
  MINIO_SECURE: ${MINIO_SECURE:-false}
  MINIO_BUCKET_NAME: ${MINIO_BUCKET_NAME:-audio-test}
  MINIO_UPLOAD_FOLDER: ${MINIO_UPLOAD_FOLDER:-storage/uploads}
  MINIO_PATH: ${MINIO_PATH:-/tmp}
  LLM_LOG_ENABLED: ${LLM_LOG_ENABLED:-true}
  DEBUG: ${DEBUG:-false}
  CELERY_BROKER_URL: ${CELERY_BROKER_URL:-redis://:@211.90.240.240:30013/7}
  CELERY_BACKEND: ${CELERY_BACKEND:-redis}
  DB_USERNAME: ${DB_USERNAME:-dify_maas}
  DB_PASSWORD: ${DB_PASSWORD:-dify_maas}
  DB_HOST: ${DB_HOST:-211.90.240.240}
  DB_PORT: ${DB_PORT:-30012}
  DB_DATABASE: ${DB_DATABASE:-digital_person_flask}
  LLM_MODEL: ${LLM_MODEL:-Qwen3-30B-A3B-GPTQ-Int4}
  DEFAULT_LLM_TEMPERATURE: ${DEFAULT_LLM_TEMPERATURE:-0}
  LLM_API_KEY: ${LLM_API_KEY:-gpustack_35c1d25d2f04a28f_900dccd6cf7d1b5fd4bc99725ce2bb0f}
  LLM_BASE_URL: ${LLM_BASE_URL:-http://211.90.240.240:30001/v1}
  MAX_TOKENS: ${MAX_TOKENS:-20480}
  ACCESS_TOKEN_EXPIRE_MINUTES: ${ACCESS_TOKEN_EXPIRE_MINUTES:-21900}
  REFRESH_TOKEN_EXPIRE_DAYS: ${REFRESH_TOKEN_EXPIRE_DAYS:-365}
  REDIS_HOST: ${REDIS_HOST:-211.90.240.240}
  REDIS_PORT: ${REDIS_PORT:-30013}
  REDIS_USERNAME: ${REDIS_USERNAME:-}
  REDIS_PASSWORD: ${REDIS_PASSWORD:-}
  REDIS_USE_SSL: ${REDIS_USE_SSL:-false}
  REDIS_SSL_CERT_REQS: ${REDIS_SSL_CERT_REQS:-CERT_NONE}
  REDIS_SSL_CA_CERTS: ${REDIS_SSL_CA_CERTS:-}
  REDIS_SSL_CERTFILE: ${REDIS_SSL_CERTFILE:-}
  REDIS_SSL_KEYFILE: ${REDIS_SSL_KEYFILE:-}
  REDIS_DB: ${REDIS_DB:-6}
  REDIS_USE_SENTINEL: ${REDIS_USE_SENTINEL:-false}
  REDIS_SENTINELS: ${REDIS_SENTINELS:-}
  REDIS_SENTINEL_SERVICE_NAME: ${REDIS_SENTINEL_SERVICE_NAME:-}
  REDIS_SENTINEL_USERNAME: ${REDIS_SENTINEL_USERNAME:-}
  REDIS_SENTINEL_PASSWORD: ${REDIS_SENTINEL_PASSWORD:-}
  REDIS_SENTINEL_SOCKET_TIMEOUT: ${REDIS_SENTINEL_SOCKET_TIMEOUT:-0.1}
  REDIS_USE_CLUSTERS: ${REDIS_USE_CLUSTERS:-false}
  REDIS_CLUSTERS: ${REDIS_CLUSTERS:-}
  REDIS_CLUSTERS_PASSWORD: ${REDIS_CLUSTERS_PASSWORD:-}

services:
  
  # API service
  api:
    image: ningtang/consultation-api:1.0.0
    restart: always
    environment:
      # Use the shared environment variables
      <<: *shared-api-worker-env
      # Startup mode, 'api' starts the API server.
      MODE: api
    ports:
      - "30032:${APP_PORT}"
    volumes:
      # Mount the storage directory to the container, for storing user files.
      - ./volumes/app/storage:/app/api/storage

  # worker service
  # The Celery worker for processing all queues
  worker:
    image: ningtang/consultation-api:1.0.0
    restart: always
    environment:
      # Use the shared environment variables
      <<: *shared-api-worker-env
      # Startup mode, 'api' starts the API server.
      MODE: worker

    volumes:
      # Mount the storage directory to the container, for storing user files.
      - ./volumes/app/storage:/app/api/storage

  # Maybe add a nginx